# Ensure Import-Excel Module is available
If (!(Get-Module -ListAvailable -Name ImportExcel)) {
    Install-Module -Name ImportExcel -Scope CurrentUser -Force
}

# Define your Azure AD App Credentials
$TenantID = "your-tenant-id"
$ClientID = "your-client-id"
$ClientSecret = "your-client-secret"

# Microsoft Graph API endpoint for Windows Autopilot Events
$GraphEndpoint = "https://graph.microsoft.com/beta/deviceManagement/windowsAutopilotDeviceIdentities"

# Function to get an access token
Function Get-AuthToken {
    $Body = @{
        client_id     = $ClientID
        scope         = "https://graph.microsoft.com/.default"
        client_secret = $ClientSecret
        grant_type    = "client_credentials"
    }
    
    $TokenResponse = Invoke-RestMethod -Uri "https://login.microsoftonline.com/$TenantID/oauth2/v2.0/token" -Method Post -Body $Body -ContentType "application/x-www-form-urlencoded"
    return $TokenResponse.access_token
}

# Get authentication token
$AccessToken = Get-AuthToken

# Function to fetch all Autopilot device events (handling pagination)
Function Get-AutopilotEvents {
    $Headers = @{
        Authorization = "Bearer $AccessToken"
        "Content-Type" = "application/json"
    }

    $AllEvents = @()
    $NextLink = $GraphEndpoint  # Initial API call

    while ($NextLink) {
        $Response = Invoke-RestMethod -Uri $NextLink -Headers $Headers -Method Get

        if ($Response.value) {
            $AllEvents += $Response.value
        }

        # Check for pagination (if @odata.nextLink exists, it means more data needs to be fetched)
        if ($Response."@odata.nextLink") {
            $NextLink = $Response."@odata.nextLink"
        } else {
            $NextLink = $null
        }
    }

    return $AllEvents
}

# Get all Autopilot events
$AutopilotEvents = Get-AutopilotEvents

# Define Output Excel File Path
$OutputExcel = "C:\Scripts\AutopilotEvents.xlsx"

# Export to Excel
$AutopilotEvents | Export-Excel -Path $OutputExcel -WorksheetName "AutopilotEvents" -AutoSize -BoldTopRow

# Output the number of records retrieved
Write-Host "Total Autopilot events retrieved: $($AutopilotEvents.Count)"
Write-Host "Data saved to $OutputExcel"
