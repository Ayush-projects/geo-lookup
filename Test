# Ensure Import-Excel Module is available
If (!(Get-Module -ListAvailable -Name ImportExcel)) {
    Install-Module -Name ImportExcel -Scope CurrentUser -Force
}

# Define your Azure AD App Credentials
$TenantID = "your-tenant-id"
$ClientID = "your-client-id"
$ClientSecret = "your-client-secret"

# Microsoft Graph API endpoint for managed devices
$GraphEndpoint = "https://graph.microsoft.com/v1.0/deviceManagement/managedDevices"

# Function to get an access token
Function Get-AuthToken {
    $Body = @{
        client_id     = $ClientID
        scope         = "https://graph.microsoft.com/.default"
        client_secret = $ClientSecret
        grant_type    = "client_credentials"
    }
    
    $TokenResponse = Invoke-RestMethod -Uri "https://login.microsoftonline.com/$TenantID/oauth2/v2.0/token" -Method Post -Body $Body -ContentType "application/x-www-form-urlencoded"
    return $TokenResponse.access_token
}

# Get authentication token
$AccessToken = Get-AuthToken

# Function to fetch all managed devices (handling pagination)
Function Get-ManagedDevices {
    $Headers = @{
        Authorization = "Bearer $AccessToken"
        "Content-Type" = "application/json"
    }

    $AllDevices = @()
    $NextLink = $GraphEndpoint  # Initial API call

    while ($NextLink) {
        $Response = Invoke-RestMethod -Uri $NextLink -Headers $Headers -Method Get

        if ($Response.value) {
            $AllDevices += $Response.value
        }

        # Check for pagination (if @odata.nextLink exists, it means more data needs to be fetched)
        if ($Response."@odata.nextLink") {
            $NextLink = $Response."@odata.nextLink"
        } else {
            $NextLink = $null
        }
    }

    return $AllDevices
}

# Get all managed devices
$ManagedDevices = Get-ManagedDevices

# Define Output Excel File Path
$OutputExcel = "C:\Scripts\ManagedDevices.xlsx"

# Export to Excel
$ManagedDevices | Export-Excel -Path $OutputExcel -WorksheetName "IntuneDevices" -AutoSize -BoldTopRow

# Output the number of devices retrieved
Write-Host "Total managed devices retrieved: $($ManagedDevices.Count)"
Write-Host "Data saved to $OutputExcel"
